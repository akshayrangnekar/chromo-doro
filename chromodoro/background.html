<html>
<head>
<script>

var Timer = function(storage) {

  var self = this;
  var timer_period = 5000; //check time every five seconds
  self.now = new Date().getTime();

  function load(name, default_value) {
    return storage[name] ? storage[name] : default_value;
  }
  
  
  var beepObject = null;
  function beep() {
    if (!beepObject) {
      beepObject = document.getElementById('beep');
    }
    beepObject.Play();
  }   
  
  // timer functions

  function countdown(seconds, reset) {
    if (reset || (time_left() <= 0)) {
      storage['count_down'] = seconds;
      storage['started_at'] = self.now;
    }
  }

  function seconds_past(from) {
  	return (self.now - from)/1000;
  }
  
  function time_left() {
    return storage['count_down'] - seconds_past(storage['started_at']);
  }
  
  
  // good Job window
  
  function goodJob() {
    chrome.windows.create({
        url:'good-job.html',
        width:150,
        height:350
      });
  }
  
  
  // states
    
  function work(reset) {
    storage['period'] = 'working';
    chrome.browserAction.setBadgeBackgroundColor({color:[180,0,0,255]});
    countdown(load('work_length', 25) * 60, reset);
  }

  function worktick(rest) {
    if (rest <= 0) {      
      goodJob();
      sleep();
      beep();
    }  
  }
  
  function sleep(reset) {
    storage['period'] = 'resting';
    chrome.browserAction.setBadgeBackgroundColor({color:[0,180,0,255]});
    countdown(load('rest_length', 5) * 60, reset);
  }

  function sleeptick(rest) {
    if (rest <= 0) {    
      work();
      beep();
    }
  }


  // the clock
  // makes sure the clock is running and defends itself against its code

  this.tick = function(first) {
    first = first ? first : false;
    
    // tick states and initialize them if needed
    try {
      var now = new Date().getTime();
      self.now = now;
      storage['last_tick'] = now;
      var rest = time_left(now);
      if (storage['period'] == 'resting') {
        if (first) {
         	sleep(false);
        }
        sleeptick(rest);
      } else if (storage['period'] == 'working') {
        if (first) {
         	work(false);
        }
        worktick(rest);
      } else {        
        return;
      }
    } catch (e) {
    	console.error(e);
    }
    
    // what applies for both states
    try {
      if (storage['period']) {
        chrome.browserAction.setTitle({title:'You are '+storage['period']+'.'});
      }
      rest = time_left(now);
      chrome.browserAction.setBadgeText({
        text : Math.ceil(rest / 60)+''
      });
    } catch (e) {
    	console.error(e);
    }
    self.timeout = setTimeout("timer.tick()", timer_period);
  }
  
  
  // initialize
  
  chrome.browserAction.setIcon({path:'chromodoro_'+load('icon', 'default')+'.png'});

  
  if (time_left() > 0) {
  	this.tick(true); // resume
  } else if (seconds_past(storage['last_tick']) < 60) {
  	this.tick(true);
  }
  
  

  chrome.browserAction.onClicked.addListener(function(tab) {
    if (storage['period'] != 'working' && storage['period'] != 'resting') {
      work(true);
      self.tick();
    } else {    
		  storage['period'] = 'stopped';
      chrome.browserAction.setTitle({title:'Click to start working cycle.'});
      chrome.browserAction.setBadgeText({text:''});
      clearTimeout(self.timeout);
    }
  });
}

var timer = new Timer(localStorage);


</script>
</head>
<body>
  <embed src="beep.wav" autostart="false" width="0" height="0" id="beep" enablejavascript="true">
</body>
</html>